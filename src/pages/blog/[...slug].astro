---
import { getCollection } from "astro:content";
import ArticleLayout from "../../layouts/ArticleLayout.astro";

export const prerender = true;

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  return blogEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}
const { entry } = Astro.props;
const { Content } = await entry.render();
---

<script type="module">
  console.log("fetching views for article");
  const baseURL = `${window.location.protocol}//${window.location.host}`;
  const pathname = window.location.pathname;
  const parts = pathname.split("/");
  const identifier = parts[parts.length - 1];

  const views = await fetch(`${baseURL}/views/getArticleViews`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ identifier }),
  })
    .then((res) => res.json())
    .then((data) => data.views)
    .catch((err) => {
      console.error(err);
      return 0;
    });

  const viewsElement = document.getElementById(`${identifier}-views`);
  if (viewsElement) viewsElement.textContent = `${views} views`;
</script>

<ArticleLayout frontmatter={entry.data}>
  <Content />
</ArticleLayout>
